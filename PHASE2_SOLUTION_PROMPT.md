# 阶段2：解决方案实施

基于阶段1调研，设计并实施高质量解决方案。

---

## ⚠️ 关键约束（最重要，必读）

### 1. 最小修改原则
- **只修复Issue明确指出的问题**，不要修复"顺便发现"的其他问题
- 能改1行就不改3行，能用现有模式就不引入新抽象
- 额外改进应作为独立Issue/PR，不要混入当前修复

### 2. 严格遵循Issue范围
- Issue指向哪个文件/行号，**就只修复那里**
- 区分"Issue要求的"和"我认为应该改进的"——只做前者
- 不要基于错误日志表象推断，要分析根本原因

### 3. 避免过度工程化
- ❌ 不添加Issue未要求的日志
- ❌ 不创建新辅助函数（除非现有代码已有此模式）
- ❌ 不为"一致性"修改其他文件
- ❌ 不假设需要修改所有CRUD（除非Issue明确要求）
- ❌ 不添加项目不需要的测试

### 4. 验证假设
- 不假设问题"已被其他PR修复"
- 参考类似Issue的历史PR，了解项目修复风格
- 如果不确定，采用**最简单**的修复方式

> **牢记：开源项目偏好最小化改动以降低风险。"做得更多"≠"做得更好"。**

### 5. 高频致命错误 ⚠️

- **字段命名必须精确** - 查SDK struct确认，不要猜测（如`runtime_environment` vs `runtime_environment_name`）
- **新字段必须有测试** - 无论多简单，acceptance test不可省略
- **Optional字段用`d.GetOk()`** - 不要用`d.Get()`直接取值，会传空字符串
- **Read中用`pointer.From()`** - 安全处理nil值

---

## 📚 参考案例（正确 vs 错误）

### 案例1：Issue #30849（SKU验证缺失）
- **Issue要求**：`HS_S_` SKU被错误拒绝设置`min_capacity`，CustomizeDiff只检查了`GP_S_`
- **标准修复**：在第120行现有条件后追加 `&& !strings.HasPrefix(..., "HS_S_")`
- **改动量**：1行
- **易犯错误**：创建`isServerlessSku()`辅助函数、修改Create/Update函数（Issue未要求）

### 案例2：Issue #31045（资源删除后报错）
- **Issue要求**：手动删除`storage_table_entity`后terraform plan报错，Read函数缺少404处理
- **标准修复**：Read函数添加 `if response.WasNotFound(...) { d.SetId(""); return nil }`
- **改动量**：4行
- **易犯错误**：同时处理403、添加日志、修改测试文件（Issue未要求）

> **从案例中学习**：标准修复都是**最小改动**，只改Issue指向的位置，不扩展范围。

---

## 核心原则

- 🎯 **治本不治标** - 解决根因，不绕过问题
- 🔍 **参考优先** - 采用调研中的相似实现和SDK函数
- 📐 **最小修改** - 只修复Issue明确指出的问题（见上方约束）
- 🔐 **动态验证** - CustomizeDiff使用API调用而非硬编码
- 📝 **Schema严谨** - Optional用Default而非Computed；有格式要求加ValidateFunc
- 🚫 **不要发明方案** - 修改框架/SDK代码前，必须先搜索代码库中解决**同类问题**的现有实现，照着它的模式来

## 独立思考要求

- ❌ 不能查看修复该Issue的PR代码（如果存在）
- ❌ 不能查看Issue评论区中直接给出的解决方案
- ✅ 必须基于阶段1调研结果独立设计方案

---

## 输出要求

⚠️ **只创建 `issue-[编号]-analysis-and-solution.md`，完成前删除其他所有临时文件**

**使用以下格式**：

```markdown
# Issue #[编号] 解决方案

## 1. 问题分析
- 问题现象
- 根本原因
- 影响范围
- Swagger链接（如果是支持新特性）

## 2. 代码调查
- 关键文件路径
- 相关函数/类/模块
- 发现的问题点

## 3. 解决方案
- 修复思路
- 具体实现方法

## 4. 代码修改

### Git操作记录
- 分支名：issue-XXX
- Commit Hash: [hash]

### 修改的文件
- `path/to/file.go` - 修改说明

### Commit信息
```
[完整commit message]
```

## 5. 测试修改

### 测试文件修改
- 修改的测试文件路径
- 新增或修改的测试用例
- 测试运行结果

## 6. 文档更新（如适用）
- 更新的文档文件路径
- 修改内容说明

## 7. 验证方法
- 测试步骤
- 预期结果

## 8. 潜在影响
- 是否影响其他功能
- 是否需要额外修改

## 9. 提交前自检（必填）⚠️

| 检查项 | 是/否 | 说明 |
|--------|-------|------|
| 修改的文件与Issue指向一致？ | | |
| 修改范围未超出Issue描述？ | | |
| 未引入新函数/新抽象？ | | |
| 未添加Issue未要求的日志？ | | |
| 代码行数变化合理？（+/-行数） | | |
| 参考了类似PR的修复风格？ | | |
| **字段名与SDK struct完全匹配？** | | 精确到`_name`/`_id`后缀 |
| **新增字段有acceptance test？** | | 不接受"太简单不需要"的理由 |

## 10. Issue 回复

> 以 "Thank you for raising the issue." 开头，英文撰写，简述根本原因和解决方案。

```
[在此填写]
```

---

## 参考：实施清单

### 1. Git操作

> ⚠️ **跨平台**：commit message必须用双引号`"`，避免多行，路径用`/`

```bash
git checkout main
git pull origin main
git checkout -b issue-[编号]
# 修改代码...
git add .
git commit -m "Fix #[编号]: [简短描述]"
git log -1 --format="%H"  # 获取commit hash
```

### 2. 代码修改

- ✅ 使用 `replace_string_in_file` / `create_file` 工具
- ✅ **只修改Issue明确要求的位置**
- ⚠️ 修改多处必须有Issue中的明确依据

### 3. 测试更新（参考项目惯例）

- 简单错误处理/文档修复 → 通常不需要新测试
- 新功能/复杂逻辑变更 → 需要测试

### 4. 文档更新

- 修改公开API/Schema → 必须更新 `.html.markdown`
- 内部实现 → 不需要

---

## 参考：质量标准

### ✅ 优秀方案
- 解决根因，不绕过
- 参考相似实现
- 使用SDK现有功能
- 代码更简洁
- **修改范围与Issue一致**

### ❌ 常见错误
- 只增加轮询/延迟（治标）
- 自己写正则/验证（重复造轮子）
- 代码更复杂（增加分支、新函数）
- **过度工程化**：修复Issue未要求的问题
- **超出范围**：Issue指向文件A，却修改文件B
- **错误假设**：假设问题已被其他PR修复
- Schema用Computed代替Default
- 有格式要求但不加ValidateFunc
- CustomizeDiff用硬编码而非API调用
- 改了Schema但不更新文档
